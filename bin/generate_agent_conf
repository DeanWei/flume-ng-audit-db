#!/bin/bash

# Copyright (C) 2016, CERN
# This software is distributed under the terms of the GNU General Public
# Licence version 3 (GPL Version 3), copied verbatim in the file "LICENSE".
# In applying this license, CERN does not waive the privileges and immunities
# granted to it by virtue of its status as Intergovernmental Organization
# or submit itself to any jurisdiction.

# Reference: http://stackoverflow.com/questions/59895/can-a-bash-script-tell-what-directory-its-stored-in
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

HOME=$SCRIPT_DIR/..

ORACLE_HOST=`hostname`
ORACLE_USER="pdbmon"
ORACLE_PASSWORD="/ORA/dbs01/syscontrol/projects/systools/bin/get_passwd password_db_pdbmon"

$HOME/bin/get_oracle_info > $HOME/conf/oracle_info

# Write header
echo "# Configuration file automatically generated by $SOURCE at $(date)" > $HOME/conf/agent.conf

# Generate Flume main configuration
FLUME_SOURCES=""
cat $HOME/conf/oracle_info | ( while read ORACLE_INST_INFO
do
	ORACLE_SID=`echo $ORACLE_INST_INFO | cut -d' ' -f1`
	
	FLUME_SOURCES="$FLUME_SOURCES audit_source_$ORACLE_SID metric_source_$ORACLE_SID alert_source_$ORACLE_SID"
done
tail -n +2 $HOME/conf/agent.conf.main.template | sed -e "s/<FLUME_SOURCES>/$FLUME_SOURCES/g" >> $HOME/conf/agent.conf
)

# Generate Flume sources
cat $HOME/conf/oracle_info | while read ORACLE_INST_INFO
do
	ORACLE_SID=`echo $ORACLE_INST_INFO | cut -d' ' -f1`
	ORACLE_VER=`echo $ORACLE_INST_INFO | cut -d' ' -f2 | cut -d'-' -f3 | cut -d'.' -f 1-5`
	ORACLE_MAIN_VER=`echo $ORACLE_VER | cut -d'.' -f1`
	
	if [ "$ORACLE_MAIN_VER" == "12" ]
	then
		ORACLE_AUDIT_TABLE=UNIFIED_AUDIT_TRAIL 	
		ORACLE_AUDIT_TABLE_DELTA_COLUMN=EVENT_TIMESTAMP
	else
		ORACLE_AUDIT_TABLE=DBA_AUDIT_TRAIL 		
		ORACLE_AUDIT_TABLE_DELTA_COLUMN=TIMESTAMP
	fi
	
	tail -n +2 $HOME/conf/agent.conf.oracle-service.template | \
		sed -e "s/<ORACLE_HOST>/$ORACLE_HOST/g" | \
		sed -e "s/<ORACLE_USER>/$ORACLE_USER/g" | \
		sed -e "s=<ORACLE_PASSWORD>=$ORACLE_PASSWORD=g" | \
		sed -e "s/<ORACLE_AUDIT_TABLE>/$ORACLE_AUDIT_TABLE/g" | \
		sed -e "s/<ORACLE_AUDIT_TABLE_DELTA_COLUMN>/$ORACLE_AUDIT_TABLE_DELTA_COLUMN/g" | \
		sed -e "s/<ORACLE_SID>/$ORACLE_SID/g" | \
		sed -e "s/<ORACLE_MAIN_VER>/$ORACLE_MAIN_VER/g" | \
		sed -e "s/<ORACLE_VER>/$ORACLE_VER/g" \
		>> $HOME/conf/agent.conf
done

chmod 644 $HOME/conf/agent.conf
chown flume:flume $HOME/conf/agent.conf

