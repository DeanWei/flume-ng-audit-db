# gateway_agent_kafka_to_elastic: agent which receives audit and log data from database instances

# Name the components on this agent
gateway_agent_kafka_to_elastic.sources = avro_source
gateway_agent_kafka_to_elastic.channels = es-channel hdfs-metric-c hdfs-audit-11-c hdfs-audit-12-c hdfs-alert-c hdfs-listener-c
gateway_agent_kafka_to_elastic.sinks = es-sink hdfs-metric-s hdfs-audit-11-s hdfs-audit-12-s hdfs-alert-s hdfs-listener-s

# Describe/configure the source
gateway_agent_kafka_to_elastic.sources.avro_source.type = avro
gateway_agent_kafka_to_elastic.sources.avro_source.bind = db-log-gateway.cern.ch
gateway_agent_kafka_to_elastic.sources.avro_source.port = 10440
gateway_agent_kafka_to_elastic.sources.avro_source.channels = es-channel hdfs-metric-c hdfs-audit-11-c hdfs-audit-12-c hdfs-alert-c hdfs-listener-c
gateway_agent_kafka_to_elastic.sources.avro_source.selector.type = multiplexing
gateway_agent_kafka_to_elastic.sources.avro_source.selector.header = source_type
gateway_agent_kafka_to_elastic.sources.avro_source.selector.mapping.audit-11 = es-channel hdfs-audit-11-c
gateway_agent_kafka_to_elastic.sources.avro_source.selector.mapping.audit-12 = es-channel hdfs-audit-12-c
gateway_agent_kafka_to_elastic.sources.avro_source.selector.mapping.metric = es-channel hdfs-metric-c
gateway_agent_kafka_to_elastic.sources.avro_source.selector.mapping.alert = es-channel hdfs-alert-c
gateway_agent_kafka_to_elastic.sources.avro_source.selector.mapping.listener = es-channel hdfs-listener-c
#gateway_agent_kafka_to_elastic.sources.avro_source.selector.mapping.default = EVENTS ARE DISCARDED

# HDFS channels
gateway_agent_kafka_to_elastic.channels.hdfs-audit-11-c.type = memory
gateway_agent_kafka_to_elastic.channels.hdfs-audit-11-c.capacity = 100000
gateway_agent_kafka_to_elastic.channels.hdfs-audit-11-c.transactionCapacity = 100000
gateway_agent_kafka_to_elastic.channels.hdfs-audit-12-c.type = memory
gateway_agent_kafka_to_elastic.channels.hdfs-audit-12-c.capacity = 100000
gateway_agent_kafka_to_elastic.channels.hdfs-audit-12-c.transactionCapacity = 100000
gateway_agent_kafka_to_elastic.channels.hdfs-metric-c.type = memory
gateway_agent_kafka_to_elastic.channels.hdfs-metric-c.capacity = 100000
gateway_agent_kafka_to_elastic.channels.hdfs-metric-c.transactionCapacity = 100000
gateway_agent_kafka_to_elastic.channels.hdfs-alert-c.type = memory
gateway_agent_kafka_to_elastic.channels.hdfs-alert-c.capacity = 100000
gateway_agent_kafka_to_elastic.channels.hdfs-alert-c.transactionCapacity = 100000
gateway_agent_kafka_to_elastic.channels.hdfs-listener-c.type = memory
gateway_agent_kafka_to_elastic.channels.hdfs-listener-c.capacity = 100000
gateway_agent_kafka_to_elastic.channels.hdfs-listener-c.transactionCapacity = 100000

# Elasticsearch channel
gateway_agent_kafka_to_elastic.channels.es-channel.type = memory
gateway_agent_kafka_to_elastic.channels.es-channel.capacity = 50000
gateway_agent_kafka_to_elastic.channels.es-channel.transactionCapacity = 50000

# HDFS sinks
gateway_agent_kafka_to_elastic.sinks.hdfs-audit-11-s.type = org.apache.flume.sink.kite.DatasetSink
gateway_agent_kafka_to_elastic.sinks.hdfs-audit-11-s.channel = hdfs-audit-11-c
gateway_agent_kafka_to_elastic.sinks.hdfs-audit-11-s.kite.dataset.uri = dataset:hdfs://p01001532067275.cern.ch:8020/user/dblogs/audit-11/
gateway_agent_kafka_to_elastic.sinks.hdfs-audit-11-s.kite.entityParser = ch.cern.db.flume.sink.kite.parser.JSONtoAvroParser$Builder
gateway_agent_kafka_to_elastic.sinks.hdfs-audit-11-s.kite.batchSize = 1000
gateway_agent_kafka_to_elastic.sinks.hdfs-audit-11-s.kite.rollInterval = 300
gateway_agent_kafka_to_elastic.sinks.hdfs-audit-11-s.auth.kerberosPrincipal = dblogs@CERN.CH
gateway_agent_kafka_to_elastic.sinks.hdfs-audit-11-s.auth.kerberosKeytab = /etc/flume-ng/db-flume-agents-gateway/conf/dblogs.keytab

gateway_agent_kafka_to_elastic.sinks.hdfs-audit-12-s.type = org.apache.flume.sink.kite.DatasetSink
gateway_agent_kafka_to_elastic.sinks.hdfs-audit-12-s.channel = hdfs-audit-12-c
gateway_agent_kafka_to_elastic.sinks.hdfs-audit-12-s.kite.dataset.uri = dataset:hdfs://p01001532067275.cern.ch:8020/user/dblogs/audit-12/
gateway_agent_kafka_to_elastic.sinks.hdfs-audit-12-s.kite.entityParser = ch.cern.db.flume.sink.kite.parser.JSONtoAvroParser$Builder
gateway_agent_kafka_to_elastic.sinks.hdfs-audit-12-s.kite.batchSize = 1000
gateway_agent_kafka_to_elastic.sinks.hdfs-audit-12-s.kite.rollInterval = 300
gateway_agent_kafka_to_elastic.sinks.hdfs-audit-12-s.auth.kerberosPrincipal = dblogs@CERN.CH
gateway_agent_kafka_to_elastic.sinks.hdfs-audit-12-s.auth.kerberosKeytab = /etc/flume-ng/db-flume-agents-gateway/conf/dblogs.keytab

gateway_agent_kafka_to_elastic.sinks.hdfs-metric-s.type = org.apache.flume.sink.kite.DatasetSink
gateway_agent_kafka_to_elastic.sinks.hdfs-metric-s.channel = hdfs-metric-c
gateway_agent_kafka_to_elastic.sinks.hdfs-metric-s.kite.dataset.uri = dataset:hdfs://p01001532067275.cern.ch:8020/user/dblogs/metric/
gateway_agent_kafka_to_elastic.sinks.hdfs-metric-s.kite.entityParser = ch.cern.db.flume.sink.kite.parser.JSONtoAvroParser$Builder
gateway_agent_kafka_to_elastic.sinks.hdfs-metric-s.kite.batchSize = 1000
gateway_agent_kafka_to_elastic.sinks.hdfs-metric-s.kite.rollInterval = 300
gateway_agent_kafka_to_elastic.sinks.hdfs-metric-s.auth.kerberosPrincipal = dblogs@CERN.CH
gateway_agent_kafka_to_elastic.sinks.hdfs-metric-s.auth.kerberosKeytab = /etc/flume-ng/db-flume-agents-gateway/conf/dblogs.keytab

gateway_agent_kafka_to_elastic.sinks.hdfs-alert-s.type = org.apache.flume.sink.kite.DatasetSink
gateway_agent_kafka_to_elastic.sinks.hdfs-alert-s.channel = hdfs-alert-c
gateway_agent_kafka_to_elastic.sinks.hdfs-alert-s.kite.dataset.uri = dataset:hdfs://p01001532067275.cern.ch:8020/user/dblogs/alert/
gateway_agent_kafka_to_elastic.sinks.hdfs-alert-s.kite.entityParser = ch.cern.db.flume.sink.kite.parser.JSONtoAvroParser$Builder
gateway_agent_kafka_to_elastic.sinks.hdfs-alert-s.kite.batchSize = 1000
gateway_agent_kafka_to_elastic.sinks.hdfs-alert-s.kite.rollInterval = 300
gateway_agent_kafka_to_elastic.sinks.hdfs-alert-s.auth.kerberosPrincipal = dblogs@CERN.CH
gateway_agent_kafka_to_elastic.sinks.hdfs-alert-s.auth.kerberosKeytab = /etc/flume-ng/db-flume-agents-gateway/conf/dblogs.keytab

gateway_agent_kafka_to_elastic.sinks.hdfs-listener-s.type = org.apache.flume.sink.kite.DatasetSink
gateway_agent_kafka_to_elastic.sinks.hdfs-listener-s.channel = hdfs-listener-c
gateway_agent_kafka_to_elastic.sinks.hdfs-listener-s.kite.dataset.uri = dataset:hdfs://p01001532067275.cern.ch:8020/user/dblogs/listener/
gateway_agent_kafka_to_elastic.sinks.hdfs-listener-s.kite.entityParser = ch.cern.db.flume.sink.kite.parser.JSONtoAvroParser$Builder
gateway_agent_kafka_to_elastic.sinks.hdfs-listener-s.kite.batchSize = 1000
gateway_agent_kafka_to_elastic.sinks.hdfs-listener-s.kite.rollInterval = 300
gateway_agent_kafka_to_elastic.sinks.hdfs-listener-s.auth.kerberosPrincipal = dblogs@CERN.CH
gateway_agent_kafka_to_elastic.sinks.hdfs-listener-s.auth.kerberosKeytab = /etc/flume-ng/db-flume-agents-gateway/conf/dblogs.keytab

# Elasticsearch sink
gateway_agent_kafka_to_elastic.sinks.es-sink.channel = es-channel
gateway_agent_kafka_to_elastic.sinks.es-sink.type = ch.cern.db.flume.sink.elasticsearch.ElasticSearchSink
gateway_agent_kafka_to_elastic.sinks.es-sink.batchSize = 1000
gateway_agent_kafka_to_elastic.sinks.es-sink.hostNames = https://es-itdb.cern.ch:9203
gateway_agent_kafka_to_elastic.sinks.es-sink.client = rest
gateway_agent_kafka_to_elastic.sinks.es-sink.client.username = itdb
gateway_agent_kafka_to_elastic.sinks.es-sink.client.password = <TO BE WRITTEN MANUALLY>
gateway_agent_kafka_to_elastic.sinks.es-sink.indexName = itdb_db-%{source_type}
gateway_agent_kafka_to_elastic.sinks.es-sink.serializer = ch.cern.db.flume.sink.elasticsearch.serializer.JSONtoElasticSearchEventSerializer
gateway_agent_kafka_to_elastic.sinks.es-sink.clusterName = itdb